# Test comparison expression on INVISIBLE COMPLEX columns in SELECT list
# This should trigger WalkQueryBlockForCustomTypeValidation

--source include/villagesql/install_complex_extension.inc

# Test 1: Incompatible types (COMPLEX vs COMPLEX2)
CREATE TABLE t1 (id INT, val1 COMPLEX INVISIBLE, val2 COMPLEX2);
INSERT INTO t1 (id, val1) VALUES (1, '(1.0,2.0)'), (2, '(3.0,4.0)');

# val1 is INVISIBLE, val2 is visible
--error ER_VILLAGESQL_GENERIC_ERROR
SELECT id, (val1 = val2) AS are_equal FROM t1;

DROP TABLE t1;

# Test 2: Incompatible types (COMPLEX vs COMPLEX2), both INVISIBLE
CREATE TABLE t2 (id INT, val1 COMPLEX INVISIBLE, val2 COMPLEX2 INVISIBLE);
INSERT INTO t2 (id, val1) VALUES (1, '(1.0,2.0)'), (2, '(3.0,4.0)');

--error ER_VILLAGESQL_GENERIC_ERROR
SELECT id, (val1 = val2) AS are_equal FROM t2;

DROP TABLE t2;

# Test 3: Table with only INVISIBLE columns - MySQL does not allow this
--error 4028
CREATE TABLE t3 (val1 COMPLEX INVISIBLE, val2 COMPLEX INVISIBLE);

# Test 4: Verify walker iterates once per result column (7 columns)
CREATE TABLE t4 (id INT, val1 COMPLEX, val2 COMPLEX);
INSERT INTO t4 (id, val1, val2) VALUES (1, '(1.0,2.0)', '(3.0,4.0)');

# SELECT with 7 result columns
SELECT id, val1, val2, id+1 AS id_plus_1, id+2 AS id_plus_2, id+3 AS id_plus_3, id+4 AS id_plus_4 FROM t4;

DROP TABLE t4;

--source include/villagesql/uninstall_complex_extension.inc
