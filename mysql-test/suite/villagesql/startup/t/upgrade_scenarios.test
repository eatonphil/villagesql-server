# Test VillageSQL upgrade system in various scenarios

--source include/big_test.inc
--source include/villagesql/internal_schema_test.inc

let BASEDIR= `select @@basedir`;
let DDIR=$MYSQL_TMP_DIR/villagesql_upgrade_test;
let MYSQLD_LOG=$MYSQL_TMP_DIR/villagesql_upgrade.log;
let extra_args=--no-defaults --innodb_dedicated_server=OFF --console --loose-skip-auto_generate_certs --loose-skip-sha256_password_auto_generate_rsa_keys --tls-version= --basedir=$BASEDIR --lc-messages-dir=$MYSQL_SHAREDIR;
let BOOTSTRAP_SQL=$MYSQL_TMP_DIR/villagesql_upgrade_bootstrap.sql;

# Create bootstrap file
write_file $BOOTSTRAP_SQL;
CREATE DATABASE test;
EOF

--echo # Test 1: Fresh installation (no villagesql schema exists)
--echo # This simulates a fresh MySQL installation with VillageSQL added

--echo # Shut server down
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server
--source include/wait_until_disconnected.inc

--echo # Initialize fresh datadir
--exec $MYSQLD $extra_args --initialize-insecure --datadir=$DDIR --init-file=$BOOTSTRAP_SQL --log-error-verbosity=1 > $MYSQLD_LOG 2>&1

--echo # Start server with fresh datadir (should trigger VillageSQL installation)
--exec echo "restart:--datadir=$DDIR " > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc

--echo # Verify fresh installation results
SELECT 'Fresh Installation' AS test_case;

--source include/villagesql/internal_schema_test.inc
SELECT COUNT(*) AS villagesql_schema_exists
FROM mysql.schemata
WHERE name = 'villagesql';

SET @villagesql_schema_id = (SELECT id FROM mysql.schemata WHERE name = 'villagesql');

SELECT COUNT(*) AS properties_table_exists
FROM mysql.tables
WHERE schema_id = @villagesql_schema_id
  AND name = 'properties';

SELECT name, value FROM villagesql.properties WHERE name = 'version';

--echo # Check that 'created' timestamp is set after fresh installation
SELECT COUNT(*) AS created_timestamp_exists
FROM villagesql.properties
WHERE name = 'created';

--echo # Store the initial created timestamp for later comparison
--let $expected_created= `SELECT value FROM villagesql.properties WHERE name = 'created'`

--echo # Test 2: Current version
--echo # A normal restart

--echo # Add a small delay to ensure timestamp will be different
--sleep 1

--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server
--source include/wait_until_disconnected.inc

--exec echo "restart:--datadir=$DDIR" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc
--source include/villagesql/internal_schema_test.inc

--echo # Verify no-op upgrade results

--echo # Verify that 'created' timestamp was not updated during normal restart
--let $actual_created =`SELECT value FROM villagesql.properties WHERE name = 'created'`
--assert($actual_created == $expected_created)

SELECT name, value FROM villagesql.properties WHERE name = 'version';

--echo # Test 3: Current version (should be no-op)
--echo # Force upgrade on already current installation

--echo # Add a small delay to ensure timestamp will be different
--sleep 1

--echo # Restart with upgrade=FORCE (should be no-op)
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server
--source include/wait_until_disconnected.inc

--exec echo "restart:--datadir=$DDIR --upgrade=FORCE" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc
--source include/villagesql/internal_schema_test.inc

--echo # Verify no-op upgrade results
SELECT 'No-op Upgrade' AS test_case;

--echo # Verify that 'created' timestamp was not updated during force update no-op
--let $actual_created =`SELECT value FROM villagesql.properties WHERE name = 'created'`
--assert($actual_created == $expected_created)

SELECT name, value FROM villagesql.properties WHERE name = 'version';

--echo # Test 4: Simulate a partial install
--echo # Manually delete the version

DELETE FROM villagesql.properties WHERE name = 'version';

SELECT 'Before Simulated Upgrade' AS test_case;
SELECT name, value FROM villagesql.properties WHERE name = 'version';

--echo # Add a small delay to ensure timestamp will be different
--sleep 1

--echo # Restart with upgrade=FORCE to trigger version upgrade
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server
--source include/wait_until_disconnected.inc

--exec echo "restart:--datadir=$DDIR --upgrade=FORCE" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc
--source include/villagesql/internal_schema_test.inc

--echo # Verify version was upgraded
SELECT 'After Simulated Upgrade' AS test_case;
SELECT name, value FROM villagesql.properties WHERE name = 'version';

--echo # Verify that 'created' timestamp was updated after forced reinstall
--let $actual_created =`SELECT value FROM villagesql.properties WHERE name = 'created'`
--assert($actual_created != $expected_created)
--let $expected_created=$actual_created

--echo # Test 5: Partial installation recovery
--echo # Drop properties table and verify it gets recreated

DROP TABLE villagesql.properties;

--source include/villagesql/internal_schema_test.inc
SELECT 'After Properties Table Dropped' AS test_case;
SELECT COUNT(*) AS properties_table_exists
FROM mysql.tables
WHERE schema_id = @villagesql_schema_id
  AND name = 'properties';

--echo # Add a small delay to ensure timestamp will be different
--sleep 1

--echo # Restart to trigger partial installation recovery
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server
--source include/wait_until_disconnected.inc

--exec echo "restart:--datadir=$DDIR --upgrade=FORCE" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc

--echo # Verify partial installation was recovered
SELECT 'After Partial Installation Recovery' AS test_case;

--source include/villagesql/internal_schema_test.inc
SELECT 'After Properties Table Dropped' AS test_case;
SELECT COUNT(*) AS properties_table_exists
FROM mysql.tables
WHERE schema_id = @villagesql_schema_id
  AND name = 'properties';

SELECT name, value FROM villagesql.properties WHERE name = 'version';

--echo # Verify that 'created' timestamp was updated after forced reinstall
--let $actual_created =`SELECT value FROM villagesql.properties WHERE name = 'created'`
--assert($actual_created != $expected_created)
--let $expected_created=$actual_created

--echo # Test 6: Check upgrade log for issues
--echo # Verify no warnings or errors occurred during upgrades

--echo # Check upgrade log for warnings
--let $assert_text= No critical errors during VillageSQL upgrades
--let $assert_file= $MYSQLD_LOG
--let $assert_select= \[ERROR\].*VillageSQL
--let $assert_count= 0
--source include/assert_grep.inc

--echo # Cleanup
--echo # Shutdown server before cleanup
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server
--source include/wait_until_disconnected.inc

# Remove test directory and files
--force-rmdir $DDIR
--remove_file $MYSQLD_LOG
--remove_file $BOOTSTRAP_SQL

--echo # Restart with original datadir
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc
