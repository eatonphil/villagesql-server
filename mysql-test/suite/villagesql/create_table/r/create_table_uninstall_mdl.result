#
# Test Case 1: CREATE TABLE fails when extension uninstalled before lock
#
# Connection con1: Skip refcount to test pure MDL protection
SET SESSION debug = '+d,skip_victionary_refcount';
# Connection con1: CREATE TABLE paused BEFORE acquiring extension lock
SET DEBUG_SYNC= 'metadata_before_extension_lock SIGNAL before_lock WAIT_FOR continue_create';
CREATE TABLE t1 (id INT PRIMARY KEY, val COMPLEX);
# Connection default: Wait for CREATE TABLE to reach sync point
SET DEBUG_SYNC= 'now WAIT_FOR before_lock';
# Connection default: UNINSTALL EXTENSION (should succeed - no lock held yet)
# Connection default: Signal CREATE TABLE to continue
SET DEBUG_SYNC= 'now SIGNAL continue_create';
# Connection con1: Reaping CREATE TABLE (should fail - extension uninstalled)
ERROR HY000: Custom type 'COMPLEX' from extension 'vsql_complex' version '0.0.1' not found
SET SESSION debug = '-d,skip_victionary_refcount';
SET DEBUG_SYNC= 'RESET';
#
# Test Case 2: UNINSTALL blocked when CREATE TABLE holds extension lock
#
# Connection con1: CREATE TABLE paused AFTER acquiring extension lock
SET DEBUG_SYNC= 'metadata_after_extension_lock SIGNAL lock_acquired WAIT_FOR continue_create';
CREATE TABLE t1 (id INT PRIMARY KEY, val COMPLEX);
# Connection default: Wait for CREATE TABLE to acquire extension lock
SET DEBUG_SYNC= 'now WAIT_FOR lock_acquired';
# Connection default: Start UNINSTALL EXTENSION (will block on MDL)
SET DEBUG_SYNC='mdl_acquire_lock_wait SIGNAL uninstall_waiting';
UNINSTALL EXTENSION vsql_complex;
# Connection default: Wait for UNINSTALL to block on MDL
SET DEBUG_SYNC='now WAIT_FOR uninstall_waiting';
# Connection default: Check MDL locks in performance_schema
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS
FROM performance_schema.metadata_locks
WHERE OBJECT_TYPE = 'EXTENSION' AND OBJECT_NAME = 'vsql_complex'
ORDER BY LOCK_STATUS;
OBJECT_TYPE	OBJECT_SCHEMA	OBJECT_NAME	LOCK_TYPE	LOCK_STATUS
EXTENSION	NULL	vsql_complex	SHARED	GRANTED
EXTENSION	NULL	vsql_complex	EXCLUSIVE	PENDING
# Connection default: Signal CREATE TABLE to continue
SET DEBUG_SYNC= 'now SIGNAL continue_create';
# Connection con1: Reaping CREATE TABLE (should succeed)
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int NOT NULL,
  `val` vsql_complex.COMPLEX DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT * FROM villagesql.custom_columns;
db_name	table_name	column_name	extension_name	extension_version	type_name
test	t1	val	vsql_complex	0.0.1	COMPLEX
# Connection con2: Reaping UNINSTALL (should fail - table t1 uses the type)
ERROR HY000: Cannot drop extension `vsql_complex` as 1 column(s) depend on it, e.g. test.t1.val has type COMPLEX
# Connection con1: DROP TABLE to remove dependency
DROP TABLE t1;
SELECT * FROM villagesql.custom_columns;
db_name	table_name	column_name	extension_name	extension_version	type_name
# Connection default: Now UNINSTALL should succeed
SET DEBUG_SYNC= 'RESET';
#
# Test Case 3: CREATE TABLE waits while UNINSTALL holds MDL X, fails after uninstall
#
# Connection con1: UNINSTALL paused after acquiring MDL X lock
SET DEBUG_SYNC= 'uninstall_after_extension_lock SIGNAL uninstall_has_lock WAIT_FOR continue_uninstall';
UNINSTALL EXTENSION vsql_complex;
# Connection default: Wait for UNINSTALL to acquire exclusive lock
SET DEBUG_SYNC= 'now WAIT_FOR uninstall_has_lock';
# Connection default: Start CREATE TABLE (will block waiting for MDL)
# Connection con2: Skip refcount to test pure MDL protection
SET SESSION debug = '+d,skip_victionary_refcount';
SET DEBUG_SYNC='mdl_acquire_lock_wait SIGNAL create_waiting';
CREATE TABLE t1 (id INT PRIMARY KEY, val COMPLEX);
# Connection default: Wait for CREATE TABLE to block on MDL
SET DEBUG_SYNC='now WAIT_FOR create_waiting';
# Connection default: Check MDL locks - UNINSTALL holds EXCLUSIVE, CREATE waits
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS
FROM performance_schema.metadata_locks
WHERE OBJECT_TYPE = 'EXTENSION' AND OBJECT_NAME = 'vsql_complex'
ORDER BY LOCK_STATUS DESC;
OBJECT_TYPE	OBJECT_SCHEMA	OBJECT_NAME	LOCK_TYPE	LOCK_STATUS
EXTENSION	NULL	vsql_complex	SHARED	PENDING
EXTENSION	NULL	vsql_complex	EXCLUSIVE	GRANTED
# Connection default: Signal UNINSTALL to continue and complete
SET DEBUG_SYNC= 'now SIGNAL continue_uninstall';
# Connection con1: Reaping UNINSTALL (should succeed)
# Connection con2: Reaping CREATE TABLE (should fail - extension uninstalled)
ERROR HY000: Custom type 'COMPLEX' from extension 'vsql_complex' version '0.0.1' not found
SET SESSION debug = '-d,skip_victionary_refcount';
SET DEBUG_SYNC= 'RESET';
