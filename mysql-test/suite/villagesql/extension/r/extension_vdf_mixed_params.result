# Test VDF with mixed parameter types
call mtr.add_suppression("Orphaned expansion directory found but not removed");
# restart: --veb-dir=MYSQLTEST_VARDIR/veb
# Create test extension with mask(BYTEARRAY, INT) -> BYTEARRAY function
Creating extension bytearray using SDK...
Created bytearray.veb
# Install extension
INSTALL EXTENSION bytearray;
# Verify extension is installed
SELECT extension_name, extension_version FROM INFORMATION_SCHEMA.EXTENSIONS;
EXTENSION_NAME	EXTENSION_VERSION
bytearray	1.0.0
#
# Test mask function with explicit BYTEARRAY creation
#
# Mask position 0
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 0)) AS result;
result
*ello   
# Mask position 1
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 1)) AS result;
result
h*llo   
# Mask position 4
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 4)) AS result;
result
hell*   
# Mask position 7 (last position in 8-byte array)
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('abcdefgh'), 7)) AS result;
result
abcdefg*
# Mask position out of range (negative) - returns unchanged
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), -1)) AS result;
result
hello   
# Mask position out of range (too large) - returns unchanged
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 100)) AS result;
result
hello   
#
# Test with NULL values
#
# NULL bytearray
SELECT bytearray.mask(NULL, 0) AS result;
result
NULL
# NULL offset
SELECT bytearray.mask(bytearray.from_string('hello'), NULL) AS result;
result
NULL
# Both NULL
SELECT bytearray.mask(NULL, NULL) AS result;
result
NULL
#
# Test with table data
#
# Create a table with BYTEARRAY column
CREATE TABLE test_data (
id INT PRIMARY KEY,
data BYTEARRAY
);
# Insert test data
INSERT INTO test_data VALUES (1, 'password');
INSERT INTO test_data VALUES (2, 'secret12');
INSERT INTO test_data VALUES (3, 'abcdefgh');
# Query original data
SELECT id, bytearray.to_string(data) AS data FROM test_data ORDER BY id;
id	data
1	password
2	secret12
3	abcdefgh
# Mask first character of each row
SELECT id,
bytearray.to_string(data) AS original,
bytearray.to_string(bytearray.mask(data, 0)) AS masked
FROM test_data ORDER BY id;
id	original	masked
1	password	*assword
2	secret12	*ecret12
3	abcdefgh	*bcdefgh
# Mask different positions for different rows using CASE
SELECT id,
bytearray.to_string(data) AS original,
bytearray.to_string(bytearray.mask(data, id - 1)) AS masked
FROM test_data ORDER BY id;
id	original	masked
1	password	*assword
2	secret12	s*cret12
3	abcdefgh	ab*defgh
# Mask multiple positions by chaining calls
SELECT id,
bytearray.to_string(data) AS original,
bytearray.to_string(
bytearray.mask(
bytearray.mask(data, 0),
1
)
) AS masked_0_1
FROM test_data ORDER BY id;
id	original	masked_0_1
1	password	**ssword
2	secret12	**cret12
3	abcdefgh	**cdefgh
# Clean up table
DROP TABLE test_data;
# Uninstall extension
UNINSTALL EXTENSION bytearray;
# Verify extension was removed
SELECT extension_name, extension_version FROM INFORMATION_SCHEMA.EXTENSIONS;
EXTENSION_NAME	EXTENSION_VERSION
include/rpl/deprecated/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
#	#	Query	#	#	use `test`; CREATE TABLE `test_data` (
  `id` int NOT NULL,
  `data` bytearray.bytearray DEFAULT NULL,
  PRIMARY KEY (`id`)
)
#	#	Query	#	#	BEGIN
#	#	Table_map	#	#	table_id: # (test.test_data)
#	#	Write_rows	#	#	table_id: # flags: STMT_END_F
#	#	Xid	#	#	COMMIT /* XID */
#	#	Query	#	#	BEGIN
#	#	Table_map	#	#	table_id: # (test.test_data)
#	#	Write_rows	#	#	table_id: # flags: STMT_END_F
#	#	Xid	#	#	COMMIT /* XID */
#	#	Query	#	#	BEGIN
#	#	Table_map	#	#	table_id: # (test.test_data)
#	#	Write_rows	#	#	table_id: # flags: STMT_END_F
#	#	Xid	#	#	COMMIT /* XID */
#	#	Query	#	#	use `test`; DROP TABLE `test_data` /* generated by server */
