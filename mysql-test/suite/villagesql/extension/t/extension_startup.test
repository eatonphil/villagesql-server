# Test that extensions are validated on server startup and orphan directories are cleaned up

# Use MYSQLTEST_VARDIR for VEB directory
--let $veb_dir = $MYSQLTEST_VARDIR/veb
--exec mkdir -p $veb_dir

# Restart server with --veb-dir option
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters = restart: --veb-dir=$veb_dir
--source include/restart_mysqld.inc
--source include/villagesql/binlog_check_begin.inc

# Create and install a test extension (uses VEF registration)
--let $extension_name = startup_test_ext
--let $extension_version = 2.0.0
--let $extension_source = $MYSQL_TEST_DIR/suite/villagesql/std_data/noop_extension.cc
--source include/villagesql/create_extension_sdk.inc

INSTALL EXTENSION startup_test_ext;

# Verify it's installed
SELECT * FROM INFORMATION_SCHEMA.EXTENSIONS;

# Create an orphan directory (simulating a leftover from an uninstalled extension)
--exec mkdir -p $veb_dir/_expanded/orphan_ext/0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

# Verify orphan directory exists before restart
--file_exists $veb_dir/_expanded/orphan_ext/0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

--source include/villagesql/binlog_check_end.inc

# Restart server - should validate extensions and cleanup orphans
# Expect warning about orphaned expansion directory
call mtr.add_suppression("Orphaned expansion directory found but not removed");
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters = restart: --veb-dir=$veb_dir
--source include/restart_mysqld.inc
--source include/villagesql/binlog_check_begin.inc

# Check error log for validation messages
--perl
use strict;
my $error_log = $ENV{'MYSQLTEST_VARDIR'} . "/log/mysqld.1.err";
open(FILE, "$error_log") or die("Unable to open error log: $error_log");
my $found_loading = 0;
my $found_validated = 0;
my $found_cleanup = 0;
while (<FILE>) {
  my $line = $_;
  if ($line =~ /VillageSQL.*Loading installed extensions/) {
    $found_loading = 1;
  }
  if ($line =~ /VillageSQL.*Validated \d+ of \d+ installed extensions/) {
    $found_validated = 1;
  }
  if ($line =~ /VillageSQL.*Cleaning up orphaned expansion directories/) {
    $found_cleanup = 1;
  }
}
close(FILE);

if (!$found_loading) {
  die "Expected to find 'Loading installed extensions' message in error log";
}
if (!$found_validated) {
  die "Expected to find 'Validated N of M installed extensions' message in error log";
}
if (!$found_cleanup) {
  die "Expected to find 'Cleaning up orphaned expansion directories' message in error log";
}

print "Found startup validation messages in error log\n";
EOF

# Verify extension still exists in table after restart
SELECT * FROM INFORMATION_SCHEMA.EXTENSIONS;

# # Verify orphan directory was removed
# --error 1
# --file_exists $veb_dir/_expanded/orphan_ext/0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

# # Verify the valid extension's directory still exists
# --file_exists $veb_dir/_expanded/startup_test_ext

# # Cleanup - uninstall the extension
# UNINSTALL EXTENSION startup_test_ext;

# Verify removed from table
SELECT * FROM INFORMATION_SCHEMA.EXTENSIONS;

--source include/villagesql/binlog_check_end.inc
