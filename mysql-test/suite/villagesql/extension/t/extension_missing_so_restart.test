# Test that server refuses to start when an extension's .so file is missing
#
# This test verifies that the server REFUSES to start when an installed
# extension's .so file is deleted from _expanded. This prevents crashes
# when accessing tables with custom types.
#
# Recovery is tested by restoring the .so file and restarting.

--let $veb_dir = $MYSQLTEST_VARDIR/veb
--exec mkdir -p $veb_dir

--let $default_veb_dir = `SELECT @@veb_dir`
--exec cp $default_veb_dir/vsql_complex.veb $veb_dir/

call mtr.add_suppression("Orphaned expansion directory found but not removed");
call mtr.add_suppression("Failed to load extension");
call mtr.add_suppression("Failed to load VEF extension");
call mtr.add_suppression("Extension loading failed");
call mtr.add_suppression("Failed to initialize");
call mtr.add_suppression("dlopen");
call mtr.add_suppression("no such file");
call mtr.add_suppression("Aborting");

--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters = restart: --veb-dir=$veb_dir
--source include/restart_mysqld.inc

# Install extension and create table with custom type
INSTALL EXTENSION vsql_complex;
SELECT * FROM INFORMATION_SCHEMA.EXTENSIONS;

CREATE TABLE test_missing_so (id INT PRIMARY KEY, c COMPLEX);
INSERT INTO test_missing_so VALUES (1, '(1.5,2.5)');
SELECT id, c FROM test_missing_so ORDER BY id;

# Move the .so file away to simulate corruption (we'll restore it later)
--perl
use strict;
my $veb_dir = $ENV{'MYSQLTEST_VARDIR'} . "/veb";
my $ext_dir = "$veb_dir/_expanded/vsql_complex";
opendir(my $dh, $ext_dir) or die "Can't open $ext_dir: $!";
my @subdirs = grep { $_ ne '.' && $_ ne '..' && -d "$ext_dir/$_" } readdir($dh);
closedir($dh);
my $lib_dir = "$ext_dir/$subdirs[0]/lib";
opendir($dh, $lib_dir) or die "Can't open $lib_dir: $!";
my @so_files = grep { /\.so$/ } readdir($dh);
closedir($dh);
my $so_path = "$lib_dir/$so_files[0]";
my $backup_path = "$lib_dir/$so_files[0].bak";
rename($so_path, $backup_path) or die "Can't move $so_path to $backup_path: $!";
print "Moved .so file away from expansion directory\n";
EOF

--echo # Restarting server - should fail due to missing .so

# Prepare error log file for capturing output
let SEARCH_FILE= $MYSQLTEST_VARDIR/log/my_restart.err;
--error 0,1
--remove_file $SEARCH_FILE

# Shutdown the server using the expect file mechanism
--let $_server_id= `SELECT @@server_id`
--let $_expect_file_name= $MYSQLTEST_VARDIR/tmp/mysqld.$_server_id.expect
--exec echo "wait" > $_expect_file_name
--shutdown_server
--source include/wait_until_disconnected.inc

# Try to start server - should fail due to missing .so file
--error 1
--exec $MYSQLD_CMD --veb-dir=$veb_dir > $SEARCH_FILE 2>&1

--echo # Server correctly refused to start

# Verify the error message appeared in the log
let SEARCH_PATTERN= Extension loading failed;
--source include/search_pattern.inc

# Restore the .so file
--perl
use strict;
my $veb_dir = $ENV{'MYSQLTEST_VARDIR'} . "/veb";
my $ext_dir = "$veb_dir/_expanded/vsql_complex";
opendir(my $dh, $ext_dir) or die "Can't open $ext_dir: $!";
my @subdirs = grep { $_ ne '.' && $_ ne '..' && -d "$ext_dir/$_" } readdir($dh);
closedir($dh);
my $lib_dir = "$ext_dir/$subdirs[0]/lib";
opendir($dh, $lib_dir) or die "Can't open $lib_dir: $!";
my @bak_files = grep { /\.so\.bak$/ } readdir($dh);
closedir($dh);
my $backup_path = "$lib_dir/$bak_files[0]";
my $so_path = $backup_path;
$so_path =~ s/\.bak$//;
rename($backup_path, $so_path) or die "Can't restore $backup_path to $so_path: $!";
print "Restored .so file to expansion directory\n";
EOF

# Restart - server should now load successfully
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters = restart: --veb-dir=$veb_dir
--source include/start_mysqld.inc

--echo # Server started after restoring .so file

# Verify extension works and data is intact
SELECT * FROM INFORMATION_SCHEMA.EXTENSIONS;
SELECT id, c FROM test_missing_so ORDER BY id;

--echo # Data intact after recovery

# Cleanup
DROP TABLE test_missing_so;
UNINSTALL EXTENSION vsql_complex;

--error 0,1
--remove_file $SEARCH_FILE
