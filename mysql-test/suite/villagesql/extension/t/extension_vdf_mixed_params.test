# Test VDF with mixed parameter types (custom type + integer)
# Demonstrates a function that takes a BYTEARRAY and an INT, returning a BYTEARRAY

--echo # Test VDF with mixed parameter types

# Setup VEB directory
--let $veb_dir = $MYSQLTEST_VARDIR/veb
--exec mkdir -p $veb_dir

# Restart server with --veb-dir option
call mtr.add_suppression("Orphaned expansion directory found but not removed");
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters = restart: --veb-dir=$veb_dir
--source include/restart_mysqld.inc
--source include/villagesql/binlog_check_begin.inc

--echo # Create test extension with mask(BYTEARRAY, INT) -> BYTEARRAY function
--let $extension_name = bytearray
--let $extension_version = 0.0.1
--let $extension_source = $MYSQL_TEST_DIR/suite/villagesql/std_data/bytearray.cc
--source include/villagesql/create_extension_sdk.inc

--echo # Install extension
INSTALL EXTENSION bytearray;

--echo # Verify extension is installed
SELECT extension_name, extension_version FROM INFORMATION_SCHEMA.EXTENSIONS;

--echo #
--echo # Test mask function with explicit BYTEARRAY creation
--echo #

--echo # Mask position 0
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 0)) AS result;

--echo # Mask position 1
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 1)) AS result;

--echo # Mask position 4
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 4)) AS result;

--echo # Mask position 7 (last position in 8-byte array)
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('abcdefgh'), 7)) AS result;

--echo # Mask position out of range (negative) - returns unchanged
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), -1)) AS result;

--echo # Mask position out of range (too large) - returns unchanged
SELECT bytearray.to_string(bytearray.mask(bytearray.from_string('hello'), 100)) AS result;

--echo #
--echo # Test with NULL values
--echo #

--echo # NULL bytearray
SELECT bytearray.mask(NULL, 0) AS result;

--echo # NULL offset
SELECT bytearray.mask(bytearray.from_string('hello'), NULL) AS result;

--echo # Both NULL
SELECT bytearray.mask(NULL, NULL) AS result;

--echo #
--echo # Test with table data
--echo #

--echo # Create a table with BYTEARRAY column
CREATE TABLE test_data (
  id INT PRIMARY KEY,
  data BYTEARRAY
);

--echo # Insert test data
INSERT INTO test_data VALUES (1, 'password');
INSERT INTO test_data VALUES (2, 'secret12');
INSERT INTO test_data VALUES (3, 'abcdefgh');

--echo # Query original data
SELECT id, bytearray.to_string(data) AS data FROM test_data ORDER BY id;

--echo # Mask first character of each row
SELECT id,
       bytearray.to_string(data) AS original,
       bytearray.to_string(bytearray.mask(data, 0)) AS masked
FROM test_data ORDER BY id;

--echo # Mask different positions for different rows using CASE
SELECT id,
       bytearray.to_string(data) AS original,
       bytearray.to_string(bytearray.mask(data, id - 1)) AS masked
FROM test_data ORDER BY id;

--echo # Mask multiple positions by chaining calls
SELECT id,
       bytearray.to_string(data) AS original,
       bytearray.to_string(
         bytearray.mask(
           bytearray.mask(data, 0),
           1
         )
       ) AS masked_0_1
FROM test_data ORDER BY id;

--echo # Clean up table
DROP TABLE test_data;

--echo # Uninstall extension
UNINSTALL EXTENSION bytearray;

--echo # Verify extension was removed
SELECT extension_name, extension_version FROM INFORMATION_SCHEMA.EXTENSIONS;

--source include/villagesql/binlog_check_end.inc
