# Test using the BYTEARRAY type and functions from vsql_simple extension
# Exercises new-style registration with actual type and function usage

--source include/villagesql/binlog_check_begin.inc

--echo # Install vsql_simple extension
INSTALL EXTENSION vsql_simple;

--echo # Verify extension is installed
SELECT extension_name, extension_version FROM INFORMATION_SCHEMA.EXTENSIONS;

--echo # Create a table with BYTEARRAY column
CREATE TABLE test_bytearray (
  id INT PRIMARY KEY,
  data BYTEARRAY
);

--echo # Insert data using the type
INSERT INTO test_bytearray VALUES (1, 'hello');
INSERT INTO test_bytearray VALUES (2, 'world123');
INSERT INTO test_bytearray VALUES (3, 'abcdefgh');

--echo # Query the data
SELECT id, data FROM test_bytearray ORDER BY id;
SELECT id, CONCAT("'", vsql_simple.bytearray_to_string(data), "'") as data FROM test_bytearray ORDER BY id;

--echo # Test rot13 function
SELECT id, data, vsql_simple.rot13(data) as rotated FROM test_bytearray ORDER BY id;
SELECT id, CONCAT("'", vsql_simple.bytearray_to_string(data), "'") as data, CONCAT("'", vsql_simple.bytearray_to_string(vsql_simple.rot13(data)), "'") as rotated FROM test_bytearray ORDER BY id;

--echo # Test even_chars function (extracts bytes at positions 0, 2, 4, 6)
SELECT id, data, vsql_simple.even_chars(data) as even FROM test_bytearray ORDER BY id;
SELECT id, CONCAT("'", vsql_simple.bytearray_to_string(data), "'") as data, CONCAT("'", vsql_simple.bytearray_to_string(vsql_simple.even_chars(data)), "'") as even FROM test_bytearray ORDER BY id;

--echo # Test odd_chars function (extracts bytes at positions 1, 3, 5, 7)
SELECT id, data, vsql_simple.odd_chars(data) as odd FROM test_bytearray ORDER BY id;
SELECT id, CONCAT("'", vsql_simple.bytearray_to_string(data), "'") as data, CONCAT("'", vsql_simple.bytearray_to_string(vsql_simple.odd_chars(data)), "'") as odd FROM test_bytearray ORDER BY id;

--echo # Test ba_concat function (returns STRING, not BYTEARRAY)
SELECT vsql_simple.ba_concat(t1.data, t2.data) as concatenated
FROM test_bytearray t1, test_bytearray t2
WHERE t1.id = 1 AND t2.id = 2;
SELECT CONCAT("'", vsql_simple.ba_concat(t1.data, t2.data), "'") as concatenated
FROM test_bytearray t1, test_bytearray t2
WHERE t1.id = 1 AND t2.id = 2;

--echo # Clean up
DROP TABLE test_bytearray;

--echo # Uninstall the extension
UNINSTALL EXTENSION vsql_simple;

--echo # Verify extension was removed
SELECT extension_name, extension_version FROM INFORMATION_SCHEMA.EXTENSIONS;

--source include/villagesql/binlog_check_end.inc
