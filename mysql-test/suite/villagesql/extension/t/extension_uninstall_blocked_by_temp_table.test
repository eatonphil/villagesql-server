# Test that UNINSTALL EXTENSION fails when a temporary table uses a custom type
# from that extension. The extension should only be uninstallable after the
# temporary table is dropped.

--source include/villagesql/install_complex_extension.inc

--echo # Create a temporary table with a COMPLEX column
CREATE TEMPORARY TABLE temp_complex (
    id INT PRIMARY KEY,
    value COMPLEX
);

--echo # Verify the temporary table exists and has the right structure
SHOW COLUMNS FROM temp_complex;

--echo # Insert some data to ensure the table is actively using the type
INSERT INTO temp_complex VALUES (1, '(1.0,2.0)');
SELECT * FROM temp_complex;

--echo # Try to uninstall the extension - should fail because temp table uses COMPLEX type
--error ER_VILLAGESQL_GENERIC_ERROR
UNINSTALL EXTENSION vsql_complex;

--echo # Verify the extension is still installed
SELECT * FROM INFORMATION_SCHEMA.EXTENSIONS WHERE EXTENSION_NAME = 'vsql_complex';

--echo # Drop the temporary table
DROP TEMPORARY TABLE temp_complex;

--echo # Now uninstall should succeed
UNINSTALL EXTENSION vsql_complex;

--echo # Verify the extension was removed
SELECT * FROM INFORMATION_SCHEMA.EXTENSIONS WHERE EXTENSION_NAME = 'vsql_complex';
