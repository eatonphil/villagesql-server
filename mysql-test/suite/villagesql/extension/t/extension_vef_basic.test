# Test VEF (VillageSQL Extension Framework) support
# Verifies that UDFs can have statically-typed raw function pointers
# for performance-critical custom type operations

--echo # Test VEF Support for Extension UDFs

# Setup VEB directory
--let $veb_dir = $MYSQLTEST_VARDIR/veb
--exec mkdir -p $veb_dir

# Restart server with --veb-dir option
call mtr.add_suppression("Orphaned expansion directory found but not removed");
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters = restart: --veb-dir=$veb_dir
--source include/restart_mysqld.inc
--source include/villagesql/binlog_check_begin.inc

--echo # Create test extension with VEF-enabled UDFs (uses VEF registration)
--let $extension_name = vef_test_ext
--let $extension_version = 0.0.1
--let $extension_source = $MYSQL_TEST_DIR/suite/villagesql/std_data/vef_byte_array.cc
--source include/villagesql/create_extension_sdk.inc

--echo # Install extension
INSTALL EXTENSION vef_test_ext;

--echo #
--echo # Test VEF_WRAP_FROM_STRING
--echo #

--echo # Call VEF-wrapped UDF from SQL - test basic functionality
SELECT HEX(vef_test_ext.byte_array_from_string('[1, 2, 3]')) AS result;

--echo # Test NULL input
SELECT vef_test_ext.byte_array_from_string(NULL) AS result;

--echo # Test invalid format returns NULL
SELECT vef_test_ext.byte_array_from_string('not an array') AS result;

--echo # Test hex format
SELECT HEX(vef_test_ext.byte_array_from_string('[0x0A, 0x0B, 0x0C]')) AS result;

--echo #
--echo # Test VEF_WRAP_COMPARE
--echo #
--echo # Compare functions NEVER return NULL. Instead, they treat NULL as a
--echo # concrete value for ordering purposes:
--echo #   - NULL == NULL  (returns 0)
--echo #   - NULL < non-NULL (returns -1)
--echo #   - non-NULL > NULL (returns 1)
--echo #

--echo # Test basic comparison: equal values
SELECT vef_test_ext.byte_array_compare('[1, 2, 3]', '[1, 2, 3]') AS result;

--echo # Test basic comparison: first < second
SELECT vef_test_ext.byte_array_compare('[1, 2, 3]', '[1, 2, 4]') AS result;

--echo # Test basic comparison: first > second
SELECT vef_test_ext.byte_array_compare('[1, 2, 4]', '[1, 2, 3]') AS result;

--echo # Test comparison with different lengths: shorter < longer
SELECT vef_test_ext.byte_array_compare('[1, 2]', '[1, 2, 3]') AS result;

--echo # Test comparison with different lengths: longer > shorter
SELECT vef_test_ext.byte_array_compare('[1, 2, 3]', '[1, 2]') AS result;

--echo #
--echo # Test VEF_WRAP_COMPARE NULL handling (NEVER returns NULL)
--echo #

--echo # NULL vs NULL: should return 0 (equal), NOT NULL
SELECT vef_test_ext.byte_array_compare(NULL, NULL) AS result;

--echo # NULL vs non-NULL: should return -1 (NULL < non-NULL), NOT NULL
SELECT vef_test_ext.byte_array_compare(NULL, '[1, 2, 3]') AS result;

--echo # non-NULL vs NULL: should return 1 (non-NULL > NULL), NOT NULL
SELECT vef_test_ext.byte_array_compare('[1, 2, 3]', NULL) AS result;

--echo # Verify compare result is never NULL by using IS NULL check
SELECT vef_test_ext.byte_array_compare(NULL, NULL) IS NULL AS is_null_result;

--echo # Uninstall extension
UNINSTALL EXTENSION vef_test_ext;

--echo # Verify UDF is removed (falls through to stored function lookup)
--error ER_SP_DOES_NOT_EXIST
SELECT vef_test_ext.byte_array_from_string('[1, 2, 3]');

--source include/villagesql/binlog_check_end.inc
