# Test MDL synchronization between ALTER TABLE ADD COLUMN using custom types
# and concurrent UNINSTALL EXTENSION.
#

--source include/have_debug_sync.inc
--source include/count_sessions.inc

--echo #
--echo # Test Case 1: ALTER TABLE ADD COLUMN waits for UNINSTALL, fails after uninstall
--echo #

--source include/villagesql/install_complex_extension.inc

CREATE TABLE t1 (id INT PRIMARY KEY, name VARCHAR(50)) ENGINE=InnoDB;

connect (con1,localhost,root);
--echo # Connection con1: UNINSTALL paused after acquiring MDL X lock
SET DEBUG_SYNC= 'uninstall_after_extension_lock SIGNAL uninstall_has_lock WAIT_FOR continue_uninstall';
--send UNINSTALL EXTENSION vsql_complex

connection default;
--echo # Connection default: Wait for UNINSTALL to acquire exclusive lock
SET DEBUG_SYNC= 'now WAIT_FOR uninstall_has_lock';

--echo # Connection default: Start ALTER TABLE ADD COLUMN (will block waiting for MDL)
connect (con2,localhost,root);
--echo # Connection con2: Skip refcount to test pure MDL protection
SET SESSION debug = '+d,skip_victionary_refcount';
SET DEBUG_SYNC='mdl_acquire_lock_wait SIGNAL alter_waiting';
--send ALTER TABLE t1 ADD COLUMN val COMPLEX

connection default;
--echo # Connection default: Wait for ALTER TABLE to block on MDL
SET DEBUG_SYNC='now WAIT_FOR alter_waiting';

--echo # Connection default: Check MDL locks - UNINSTALL holds EXCLUSIVE, ALTER waits
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS
FROM performance_schema.metadata_locks
WHERE OBJECT_TYPE = 'EXTENSION' AND OBJECT_NAME = 'vsql_complex'
ORDER BY LOCK_STATUS DESC;

--echo # Connection default: Signal UNINSTALL to continue and complete
SET DEBUG_SYNC= 'now SIGNAL continue_uninstall';

connection con1;
--echo # Connection con1: Reaping UNINSTALL (should succeed)
reap;

connection con2;
--echo # Connection con2: Reaping ALTER TABLE (should fail - extension uninstalled)
--error ER_VILLAGESQL_GENERIC_ERROR
reap;
SET SESSION debug = '-d,skip_victionary_refcount';

disconnect con1;
disconnect con2;

connection default;
DROP TABLE t1;
SET DEBUG_SYNC= 'RESET';

--echo #
--echo # Test Case 2: UNINSTALL blocked when ALTER TABLE ADD COLUMN holds extension lock
--echo #

--source include/villagesql/install_complex_extension.inc

CREATE TABLE t1 (id INT PRIMARY KEY, name VARCHAR(50)) ENGINE=InnoDB;

connect (con1,localhost,root);
--echo # Connection con1: ALTER TABLE ADD COLUMN paused AFTER acquiring extension lock
SET DEBUG_SYNC= 'metadata_after_extension_lock SIGNAL lock_acquired WAIT_FOR continue_alter';
--send ALTER TABLE t1 ADD COLUMN val COMPLEX

connection default;
--echo # Connection default: Wait for ALTER TABLE to acquire extension lock
SET DEBUG_SYNC= 'now WAIT_FOR lock_acquired';

--echo # Connection default: Start UNINSTALL EXTENSION (will block on MDL)
connect (con2,localhost,root);
SET DEBUG_SYNC='mdl_acquire_lock_wait SIGNAL uninstall_waiting';
--send UNINSTALL EXTENSION vsql_complex

connection default;
--echo # Connection default: Wait for UNINSTALL to block on MDL
SET DEBUG_SYNC='now WAIT_FOR uninstall_waiting';

--echo # Connection default: Check MDL locks in performance_schema
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS
FROM performance_schema.metadata_locks
WHERE OBJECT_TYPE = 'EXTENSION' AND OBJECT_NAME = 'vsql_complex'
ORDER BY LOCK_STATUS;

--echo # Connection default: Signal ALTER TABLE to continue
SET DEBUG_SYNC= 'now SIGNAL continue_alter';

connection con1;
--echo # Connection con1: Reaping ALTER TABLE (should succeed)
reap;
SHOW CREATE TABLE t1;
--source include/villagesql/query_custom_columns.inc

connection con2;
--echo # Connection con2: Reaping UNINSTALL (should fail - table t1 uses the type)
--error ER_VILLAGESQL_GENERIC_ERROR
reap;

connection con1;
--echo # Connection con1: DROP TABLE to remove dependency
DROP TABLE t1;
--source include/villagesql/query_custom_columns.inc

disconnect con1;
disconnect con2;

connection default;
--echo # Connection default: Now UNINSTALL should succeed
--source include/villagesql/uninstall_complex_extension.inc
SET DEBUG_SYNC= 'RESET';
--source include/wait_until_count_sessions.inc
