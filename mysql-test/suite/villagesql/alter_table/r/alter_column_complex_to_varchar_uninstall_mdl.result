#
# Test Case 1: MODIFY COLUMN from custom to normal type (similar to DROP COLUMN)
# Does NOT acquire extension MDL lock, but UNINSTALL fails until MODIFY completes
#
CREATE TABLE t1 (id INT PRIMARY KEY, val COMPLEX) ENGINE=InnoDB;
# Verify column uses custom type
SELECT * FROM villagesql.custom_columns;
db_name	table_name	column_name	extension_name	extension_version	type_name
test	t1	val	vsql_complex	0.0.1	COMPLEX
# Connection con1: Skip refcount to test pure MDL and dependency protection
SET SESSION debug = '+d,skip_victionary_refcount';
# Connection con1: Set up two debug sync points for MODIFY COLUMN
SET DEBUG_SYNC= 'metadata_before_extension_lock SIGNAL before_lock WAIT_FOR continue_modify_1';
SET DEBUG_SYNC= 'metadata_after_extension_lock SIGNAL after_lock WAIT_FOR continue_modify_2';
ALTER TABLE t1 MODIFY COLUMN val VARCHAR(50);
# Connection default: Wait for MODIFY COLUMN to reach first sync point (before lock)
SET DEBUG_SYNC= 'now WAIT_FOR before_lock';
# Connection default: Check MDL queue - should have NO extension locks
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS
FROM performance_schema.metadata_locks
WHERE OBJECT_TYPE = 'EXTENSION' AND OBJECT_NAME = 'vsql_complex';
OBJECT_TYPE	OBJECT_SCHEMA	OBJECT_NAME	LOCK_TYPE	LOCK_STATUS
# Connection default: Try UNINSTALL at stage 1 (should fail - column exists)
UNINSTALL EXTENSION vsql_complex;
ERROR HY000: Cannot drop extension `vsql_complex` as 1 column(s) depend on it, e.g. test.t1.val has type COMPLEX
# Connection default: Signal MODIFY COLUMN to continue to second sync point
SET DEBUG_SYNC= 'now SIGNAL continue_modify_1';
SET DEBUG_SYNC= 'now WAIT_FOR after_lock';
# Connection default: Check MDL queue again - should still have NO extension locks
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS
FROM performance_schema.metadata_locks
WHERE OBJECT_TYPE = 'EXTENSION' AND OBJECT_NAME = 'vsql_complex';
OBJECT_TYPE	OBJECT_SCHEMA	OBJECT_NAME	LOCK_TYPE	LOCK_STATUS
# Connection con2: Try UNINSTALL at stage 2 (should still fail - column not modified yet)
UNINSTALL EXTENSION vsql_complex;
ERROR HY000: Cannot drop extension `vsql_complex` as 1 column(s) depend on it, e.g. test.t1.val has type COMPLEX
# Connection default: Signal MODIFY COLUMN to complete
SET DEBUG_SYNC= 'now SIGNAL continue_modify_2';
# Connection con1: Reaping ALTER TABLE (should succeed)
SET SESSION debug = '-d,skip_victionary_refcount';
# Connection con1: Verify column is now normal type
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int NOT NULL,
  `val` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT * FROM villagesql.custom_columns;
db_name	table_name	column_name	extension_name	extension_version	type_name
# Connection con2: Now UNINSTALL should succeed (no custom type usage)
UNINSTALL EXTENSION vsql_complex;
DROP TABLE t1;
SET DEBUG_SYNC= 'RESET';
