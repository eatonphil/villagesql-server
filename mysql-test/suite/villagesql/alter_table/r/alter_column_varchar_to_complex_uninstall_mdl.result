#
# Test Case 1: MODIFY COLUMN from normal to custom type
# Acquires extension MDL lock, UNINSTALL blocked then fails due to new dependency
#
CREATE TABLE t1 (id INT PRIMARY KEY, val VARCHAR(50)) ENGINE=InnoDB;
# Verify no custom columns initially
SELECT * FROM villagesql.custom_columns;
db_name	table_name	column_name	extension_name	extension_version	type_name
# Connection con1: ALTER TABLE MODIFY COLUMN (normal->custom) paused AFTER acquiring extension lock
SET DEBUG_SYNC= 'metadata_after_extension_lock SIGNAL lock_acquired WAIT_FOR continue_alter';
ALTER TABLE t1 MODIFY COLUMN val COMPLEX;
# Connection default: Wait for ALTER TABLE to acquire extension lock
SET DEBUG_SYNC= 'now WAIT_FOR lock_acquired';
# Connection default: Start UNINSTALL EXTENSION (will block on MDL)
SET DEBUG_SYNC='mdl_acquire_lock_wait SIGNAL uninstall_waiting';
UNINSTALL EXTENSION vsql_complex;
# Connection default: Wait for UNINSTALL to block on MDL
SET DEBUG_SYNC='now WAIT_FOR uninstall_waiting';
# Connection default: Check MDL locks - MODIFY holds SHARED, UNINSTALL waits for EXCLUSIVE
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_STATUS
FROM performance_schema.metadata_locks
WHERE OBJECT_TYPE = 'EXTENSION' AND OBJECT_NAME = 'vsql_complex'
ORDER BY LOCK_STATUS;
OBJECT_TYPE	OBJECT_SCHEMA	OBJECT_NAME	LOCK_TYPE	LOCK_STATUS
EXTENSION	NULL	vsql_complex	SHARED	GRANTED
EXTENSION	NULL	vsql_complex	EXCLUSIVE	PENDING
# Connection default: Signal ALTER TABLE to continue
SET DEBUG_SYNC= 'now SIGNAL continue_alter';
# Connection con1: Reaping ALTER TABLE (should succeed)
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int NOT NULL,
  `val` vsql_complex.COMPLEX DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT * FROM villagesql.custom_columns;
db_name	table_name	column_name	extension_name	extension_version	type_name
test	t1	val	vsql_complex	0.0.1	COMPLEX
# Connection con2: Reaping UNINSTALL (should fail - column now uses custom type)
ERROR HY000: Cannot drop extension `vsql_complex` as 1 column(s) depend on it, e.g. test.t1.val has type COMPLEX
# Connection con1: DROP TABLE to remove dependency
DROP TABLE t1;
# Connection default: Now UNINSTALL should succeed
SET DEBUG_SYNC= 'RESET';
