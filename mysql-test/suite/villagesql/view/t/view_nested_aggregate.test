# Test nested VIEW with aggregation on COMPLEX column
# Uses values that differentiate semantic from string ordering
# Orders by COMPLEX column to verify semantic ordering in aggregated nested view

--source include/villagesql/install_complex_extension.inc

CREATE TABLE t1 (id INT PRIMARY KEY, val COMPLEX, amount DECIMAL(10,2));

INSERT INTO t1 VALUES
  (1, '(2,0)', 100.50),
  (2, '(10,0)', 200.75),
  (3, '(-1,0)', 50.00),
  (4, '(-10,0)', 150.25),
  (5, '(0,-5)', 75.50),
  (6, '(0,-10)', 125.00);

# Create base view
CREATE VIEW v_base AS
SELECT id, val, amount FROM t1;

# Create view with aggregation on nested view, grouping by COMPLEX column
CREATE VIEW v_aggregated AS
SELECT val, SUM(amount) AS total_amount
FROM v_base
GROUP BY val;

SELECT * FROM v_aggregated ORDER BY total_amount;

SELECT * FROM v_aggregated ORDER BY val;

DROP VIEW v_aggregated;
DROP VIEW v_base;
DROP TABLE t1;

--source include/villagesql/uninstall_complex_extension.inc
