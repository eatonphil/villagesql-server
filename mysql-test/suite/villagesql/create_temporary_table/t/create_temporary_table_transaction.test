# Test transactional behavior with temporary tables containing COMPLEX columns
# Verifies ROLLBACK and COMMIT work correctly with InnoDB temporary tables

--source include/villagesql/install_complex_extension.inc

# Create InnoDB temporary table (transactional)
CREATE TEMPORARY TABLE t_trans (
  id INT PRIMARY KEY,
  val COMPLEX,
  amount DECIMAL(10,2)
) ENGINE=InnoDB;

# Test 1: Basic transaction with COMMIT
START TRANSACTION;
INSERT INTO t_trans VALUES (1, '(2,0)', 100.50);
INSERT INTO t_trans VALUES (2, '(10,0)', 200.75);
COMMIT;

SELECT * FROM t_trans ORDER BY id;

# Test 2: Transaction with ROLLBACK
START TRANSACTION;
INSERT INTO t_trans VALUES (3, '(-1,0)', 50.00);
SELECT * FROM t_trans ORDER BY id;
ROLLBACK;

SELECT * FROM t_trans ORDER BY id;

# Test 3: Multiple operations in transaction
START TRANSACTION;
INSERT INTO t_trans VALUES (3, '(-1,0)', 50.00);
INSERT INTO t_trans VALUES (4, '(5,5)', 75.25);
UPDATE t_trans SET amount = 150.00 WHERE id = 1;
SELECT * FROM t_trans ORDER BY id;
ROLLBACK;

SELECT * FROM t_trans ORDER BY id;

# Test 4: Nested transaction (SAVEPOINT)
START TRANSACTION;
INSERT INTO t_trans VALUES (3, '(-1,0)', 50.00);
SAVEPOINT sp1;
INSERT INTO t_trans VALUES (4, '(5,5)', 75.25);
SAVEPOINT sp2;
INSERT INTO t_trans VALUES (5, '(7,7)', 125.00);
ROLLBACK TO SAVEPOINT sp2;
SELECT * FROM t_trans ORDER BY id;
ROLLBACK TO SAVEPOINT sp1;
SELECT * FROM t_trans ORDER BY id;
COMMIT;

SELECT * FROM t_trans ORDER BY id;

# Test 5: DELETE with ROLLBACK
START TRANSACTION;
DELETE FROM t_trans WHERE val = '(2,0)';
SELECT * FROM t_trans ORDER BY id;
ROLLBACK;

SELECT * FROM t_trans ORDER BY id;

DROP TABLE t_trans;

--source include/villagesql/uninstall_complex_extension.inc
