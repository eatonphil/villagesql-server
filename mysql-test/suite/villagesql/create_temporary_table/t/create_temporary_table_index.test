# Test indexing on COMPLEX columns in temporary tables
# Verifies that indexes can be created and used for lookups

--source include/villagesql/install_complex_extension.inc

CREATE TEMPORARY TABLE t_idx (
  id INT PRIMARY KEY,
  val COMPLEX,
  description VARCHAR(50),
  INDEX idx_val(val)
);

# Insert test data
INSERT INTO t_idx VALUES
  (1, '(2,0)', 'first'),
  (2, '(10,0)', 'second'),
  (3, '(-1,0)', 'third'),
  (4, '(2,0)', 'duplicate'),
  (5, '(5.0,5.0)', 'fourth');

# Verify metadata shows the index
SHOW CREATE TABLE t_idx;
SHOW INDEXES FROM t_idx;

# Query using indexed column
SELECT * FROM t_idx WHERE val = '(2,0)' ORDER BY id;

# Verify index is used in execution plan
EXPLAIN SELECT * FROM t_idx WHERE val = '(2,0)';

# Test ORDER BY on indexed column
SELECT * FROM t_idx ORDER BY val;

# Test range query (if supported by custom type)
SELECT * FROM t_idx WHERE val IN ('(2,0)', '(10,0)') ORDER BY id;

DROP TABLE t_idx;

# Test creating index after table creation
CREATE TEMPORARY TABLE t_idx2 (
  id INT,
  val COMPLEX
);

INSERT INTO t_idx2 VALUES (1, '(3.0,4.0)'), (2, '(1.0,2.0)');

# Add index after creation
CREATE INDEX idx_val2 ON t_idx2(val);

SHOW INDEXES FROM t_idx2;
SELECT * FROM t_idx2 WHERE val = '(3,4)';

DROP TABLE t_idx2;

--source include/villagesql/uninstall_complex_extension.inc
