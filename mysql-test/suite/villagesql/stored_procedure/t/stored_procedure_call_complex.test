# Test stored procedures with mixed custom and non-custom columns
# This test verifies field-level blocking: procedures accessing only non-custom
# columns should succeed, while procedures accessing custom columns should fail

--source include/villagesql/install_complex_extension.inc

# Create table with both custom and non-custom columns
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  val COMPLEX,
  age INT
);

# Create audit table with only non-custom columns
CREATE TABLE audit_log (
  table_id INT,
  name VARCHAR(50)
);

delimiter //;

# Test 1: Procedure that only accesses non-custom columns - should succeed
CREATE PROCEDURE sp_insert_audit(IN p_id INT, IN p_name VARCHAR(50))
BEGIN
  INSERT INTO audit_log (table_id, name) VALUES (p_id, p_name);
END//

# Test 2: Procedure that reads only non-custom columns - should succeed
CREATE PROCEDURE sp_get_names()
BEGIN
  SELECT id, name FROM t1 ORDER BY id;
END//

# Test 3: Procedure with COMPLEX parameter - should fail at creation time
--error ER_VILLAGESQL_GENERIC_ERROR
CREATE PROCEDURE sp_with_custom_param(IN val_param COMPLEX)
BEGIN
  SELECT val_param;
END//

# Test 4: Procedure that accesses custom column - will fail when called
CREATE PROCEDURE sp_get_custom(IN p_id INT)
BEGIN
  SELECT id, val FROM t1 WHERE id = p_id;
END//

delimiter ;//

# Insert test data
INSERT INTO t1 VALUES (1, 'Alice', '(1.0,2.0)', 25);
INSERT INTO t1 VALUES (2, 'Bob', '(3.0,4.0)', 30);

# Call procedure that only uses non-custom columns - should succeed
CALL sp_insert_audit(1, 'Alice');
SELECT * FROM audit_log;

# Call procedure that reads non-custom columns - should succeed
CALL sp_get_names();

# Call procedure that accesses custom column - should fail
--error ER_VILLAGESQL_GENERIC_ERROR
CALL sp_get_custom(1);

# Verify LEX flag is reset: call non-custom procedure again - should succeed
# This ensures the found_custom_type_in_context flag doesn't persist
CALL sp_get_names();

# Clean up
DROP PROCEDURE sp_insert_audit;
DROP PROCEDURE sp_get_names;
DROP PROCEDURE sp_get_custom;
DROP TABLE t1;
DROP TABLE audit_log;

--source include/villagesql/uninstall_complex_extension.inc
