-- Copyright (c) 2026 VillageSQL Contributors
--
-- This program is free software; you can redistribute it and/or
-- modify it under the terms of the GNU General Public License
-- as published by the Free Software Foundation; either version 2
-- of the License, or (at your option) any later version.
--
-- This program is distributed in the hope that it will be useful,
-- but WITHOUT ANY WARRANTY; without even the implied warranty of
-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-- GNU General Public License for more details.
--
-- You should have received a copy of the GNU General Public License
-- along with this program; if not, see <https://www.gnu.org/licenses/>.

-- VillageSQL System Schema Definition

-- NOTE: Keep this schema in sync with villagesql/schema/schema_manager.cc
-- The schema_manager.cc file contains TABLE_FIELD_DEF definitions that must
-- match the tables defined here. Any changes to table structure must be
-- reflected in both files for validation to work correctly.

-- Create the villagesql database if it doesn't exist
CREATE DATABASE IF NOT EXISTS villagesql;

-- FUTURE TABLES GO HERE!

CREATE TABLE IF NOT EXISTS villagesql.extensions (
  extension_name VARCHAR(64) NOT NULL COMMENT 'Extension name',
  extension_version VARCHAR(64) NOT NULL COMMENT 'Version of the extension',
  veb_sha256 VARCHAR(64) NOT NULL COMMENT 'SHA256 hash of the VEB file in hex',
  PRIMARY KEY (extension_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
ROW_FORMAT=DYNAMIC
COMMENT='VillageSQL installed extensions registry';

CREATE TABLE IF NOT EXISTS villagesql.custom_columns (
  db_name VARCHAR(64) NOT NULL COMMENT 'Database name',
  table_name VARCHAR(64) NOT NULL COMMENT 'Table name',
  column_name VARCHAR(64) NOT NULL COMMENT 'Column name',
  extension_name VARCHAR(64) NOT NULL COMMENT 'Extension name implementing the custom type for this column',
  extension_version VARCHAR(64) NOT NULL COMMENT 'Version of the extension',
  type_name VARCHAR(64) NOT NULL COMMENT 'Custom type from extension',
  PRIMARY KEY (db_name, table_name, column_name),
  INDEX idx_extension (extension_name, extension_version, type_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
ROW_FORMAT=DYNAMIC
COMMENT='VillageSQL columns that use custom types';

-- Store VillageSQL system properties (version, configuration, etc.)
-- NOTE: THIS MUST BE THE FINAL TABLE IN THIS FILE!
-- Reason: we detect a partial install by seeing the schema exists but
-- that this table is missing (or we are missing the version from the
-- single INSERT just below this).
CREATE TABLE IF NOT EXISTS villagesql.properties (
  name VARCHAR(64) NOT NULL COMMENT 'Property name',
  value LONGTEXT COMMENT 'Property value',
  description TEXT COMMENT 'Property description',
  PRIMARY KEY (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
ROW_FORMAT=DYNAMIC
COMMENT='VillageSQL system properties and configuration';

-- Initialize system properties
-- NOTE: version is set by CMake from VSQL_VERSION file during build
-- NOTE: this must be the last statement in this file to ensure the
-- properties are updated only after all previous statements
INSERT INTO villagesql.properties (name, value, description) VALUES
('version', '@VSQL_VERSION_STRING@', 'VillageSQL system schema version'),
('created', NOW(), 'Schema creation timestamp'),
('mysql_version_at_creation', @@version, 'MySQL version when VillageSQL schema was created')
ON DUPLICATE KEY UPDATE value = VALUES(value), description = VALUES(description);

